# 重建路由

1. 检测路由是否全部过载。若是，立即尝试宕机恢复。

2. 每30s（默认1分钟）一次路由重建周期。若当前时间距离上次重建时间间隔的绝对值大于2倍路由重建周期，路由将不会重建。

3. 使用已有统计数据计算节点各项指标（门限、成功率、平均延时）：

    * 首先保存上周期统计数据为本周期统计数：总请求数、拒绝数、错误数、超时数、成功数。

    * 其次若本周期无总请求数、无错误数及无成功数，则将成功率置为1.0，并清除本周期统计数据：总请求数、拒绝数、错误数、超时数、成功数、总延时、分配数、连续错误数。注意：平均延时不变。

    * 然后计算节点平均延时：
        * 若成功请求数大于0，则平均延时为：总延时/成功数。
        * 若成功请求数小于等于0，且总请求数大于预设最低请求数，则置其为最大延时值（1亿us=100s）。
        * 若成功请求数小于等于0，且总请求数小于等于预设最低请求数，且上个周期平均延时小于最大延值，增大其值至2倍。
        * 若成功请求数小于等于0，且总请求数小于等于预设最低请求数，且上个周期平均延时大于等于最大延值，置其值为默认值（100万=1s）。

    * 门限计算
        * 初始化节点门限值为：若本周期总请求数大于预设最低请求数，置其为总请求数。否则置其为预设最低请求数+1。
        * 门限收缩（本周期节点有效错误率大于预设最低错误率）：若总请求数大于门限值，则收缩值为：门限*有效错误率；若总请求数小于门限值，则收缩值为：总请求数*有效错误率。并且，若总请求数大于预设最低请求数，需要记录这个总请求数为过度扩张的警报值（逻辑上可认为：因为上个周期门限的扩张，从而使本周期的访问量增大，却又导致了本周期有效错误率超过了预设最低错误率）。
        * 门限扩张（本周期有效错误率小于等于预设最低错误率）：若本周期的成功请求数超过上次过度扩张时的阀值（即：判定为不存在过度扩张），则扩张值为：（门限*扩张因子/delay_load）与（预设最低请求数最小值）中的最大值；若本周期的成功请求数未超过上次过度扩张时的阀值（存在过度扩张），则扩张值为：（上次过度扩张时的报警值-本周期请求数）*扩张因子 与 （预设最低请求数最小值）中的最大值。
        * 宕机嫌疑：若节点门限大于预设最低请求数，且节点连续失败次数累加达到预设最大宕机值，则该节点有宕机嫌疑；若节点门限大于预设最低请求数，且节点错误率大于预设最大宕机错误率，则该节点由宕机嫌疑。以上将其门限值都设置为预设最低请求数+1。

    * 门限不能越过预设最大请求数、预设最小请求数边界。

    * 清除本周期统计数据：总请求数、拒绝数、错误数、超时数、成功数、总延时、分配数、连续错误数。注意：平均延时不变。

4. 节点错误率超过预设最低错误率，有过载嫌疑。发短信？

5. 所有节点错误率都超过预设最低错误率，有全部过载嫌疑。发短信？

6. 更新宕机节点请求数为路由所有节点的总请求数。

7. 负载计算
    * w(k) = delay_load(k) * ok_load(k)*weight_load(k)
    * delay_load(k) = delay(k)/min(delay(0)..delay(n))
    * ok_load(k) = max(ok_rate(0)..ok_rate(n)) /ok_rate(k)
    * weight_load(k)=max(weight_load(0)..weight_load(n))/ weight_load(k)

8. 设置节点就近标志位：节点cityid==agent.idc判定为就近。

9. 若一节点门限值小于等于预设最低请求量，则删除该节点并将其加入到宕机列表中。压力故障。

10. 所有节点门限都小于等于预设最低请求量，认为非压力故障。发短信？

11. 分配索引到回到起始位置。
